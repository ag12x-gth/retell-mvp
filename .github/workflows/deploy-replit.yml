name: ğŸš€ Deploy to Replit

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  validate:
    name: âœ… Validate Project
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
      
      - name: ğŸ”¨ Build Project
        run: npm run build
      
      - name: ğŸ§ª Run Tests
        run: npm test || echo "No tests configured"
      
      - name: ğŸ” Lint Code
        run: npm run lint || echo "No linting configured"
      
      - name: âœ… Prisma Validate
        run: npx prisma validate
      
      - name: ğŸ“Š Generate Prisma Client
        run: npx prisma generate
  
  security:
    name: ğŸ” Security Scan
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ” Check for Secrets
        run: |
          echo "ğŸ” Verificando credenciais expostas..."
          if grep -r "sk-proj-" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âŒ ERRO: OpenAI API Key encontrada no cÃ³digo!"
            exit 1
          fi
          if grep -r "AC801c" . --exclude-dir=node_modules --exclude-dir=.git --exclude=".env.example"; then
            echo "âš ï¸ WARNING: Twilio SID encontrado (verificar se Ã© .env.example)"
          fi
          echo "âœ… Nenhuma credencial exposta encontrada"
      
      - name: ğŸ›¡ï¸ NPM Audit
        run: npm audit --production || true
  
  notify:
    name: ğŸ“¢ Notify Deployment
    runs-on: ubuntu-latest
    needs: [validate, security]
    
    steps:
      - name: ğŸ“¢ Success Message
        run: |
          echo "âœ… Build validado com sucesso!"
          echo "ğŸš€ Pronto para import no Replit:"
          echo "   https://replit.com/github/${{ github.repository }}"
